#                                  机器狗 项目记录

## 项目介绍：

  vue3 + threejs + Go2开发型机器狗     ，实现在threejs中加载机器狗扫描的点云数据， 通过在三维模型上 画路线，然后传点位数据给后台。  后台接收点位信息，调用宇树的api，启动按点走路。  同时调用狗的监控视频，实现巡检。

 

## 关键问题点： 

1.  核心问题，狗的机器人坐标， 和threejs的世界坐标， 不一致的问题。 还有两者的空间比例尺问题。
2.  获取狗位置的精确度问题。 实测大概有1-3m左右的误差。
3. 操纵狗的代码逻辑层多，且服务不稳定问题。 从web页面，点击发出巡检指令，到狗启动，至少经过web前端，java,狗自身的服务。



## 参考资料收集

Go2 SDK 开发指南  

https://support.unitree.com/home/zh/developer/Motion%20Application

# 系统架构图

![](https://doc-cdn.unitree.com/static/2023/11/1/ba83e42eb9234d5e8824a9578140db31_8000x4500.jpg)



**基础须知**

### 机器人坐标系

机器人的坐标系定义为：X 朝前，Y 朝左，Z 朝上。机器人站立时的默认离地高度为 0.33m，左前足距离机体中心的距离为 [x:0.19257, y:0.135]，行走时的抬腿高度 0.09m。



![](https://doc-cdn.unitree.com/static/2023/9/5/7ba474139e0e46878156aebf948a1bdb_8000x4500.jpg)



![](https://doc-cdn.unitree.com/static/2023/9/5/46cc9394c1dc45e4b41d6c9f9de8aeae_8000x4500.jpg)

### threejs坐标和机器狗坐标对比





![](.\img\2.png)

  模型的朝向问题： 

​    threejs中， 弧度0，朝向负Z轴，  dog.rotation.y

​      机器狗中，弧度0，朝向x轴。







 机器人状态

![](https://doc-cdn.unitree.com/static/2023/9/5/412a498fced04f41b20cfbccd55e575f_8000x4500.jpg)

**网络服务**

https://support.unitree.com/home/zh/developer/network%20service

Go2 支持的网络连接有 **Wi-Fi STA**，**Wi-Fi AP** 和 **4G** 三种模式。其中 **Wi-Fi STA**，**Wi-Fi AP**开放给用户设置。

- **Wi-Fi STA** ： Go2 连接至环境中某 **Wi-Fi** 热点，实现外网访问能力。
- **Wi-Fi AP** ： Go2 自带的热点，为自建的局域网，支持手机等设备连接。
- **4G** ：Go2 自带的 4G 物联网卡连接至运营商基站，实现外网访问能力。

**UWB 服务**

# 一 、概述

Unitree Go2 UWB 是一款宇树科技自研的矢量定位模组，可实现机身平面内的厘米级定位。内置3轴加速度计和3轴陀螺仪 IMU，可提供标签的姿态。该模组应用于 Go2 集成的伴随功能，也可用于用户二次开发。

![](https://doc-cdn.unitree.com/static/2023/8/8/e96a4a4e42dd43d8834fc0394635589b_5000x2813.png)

## **获取 SDK**

## SDK 介绍

**unitree_sdk2** 是宇树科技为新一代机器人开发的 SDK。SDK 将底层电机控制、高层运动控制、**雷达点云数据**、音视频图传、SLAM、里程计等接口进行封装，并提供相关的函数接口。您可以按照我们提供的接口和例程，配套 《Go2 SDK 开发指南》，学习机器人控制，完成 Go2 的二次开发。

## SDK 支持情况

**unitree_sdk2** 目前支持的机器人为 Unitree Go2 EDU 版。其他型号或版本的机器人不支持使用该 SDK 进行二次开发。

> SDK 同时支持 Unitree B2、Unitree H1 机器人。



### 系统环境

推荐在 Ubuntu 20.04 系统下进行开发, 暂不支持在 Mac、Windows 系统下进行开发, 且不支持在 Go2 的内置电脑上开发。

### 网络环境

需将用户电脑中与 Go2 机器人通信的网卡设置在 123 网段下，且该网卡的ip地址建议设置为 192.168.123.222 (“222”可以改成其他)。不允许将该网卡的ip地址设置为 192.168.123.161，此为 Go2 机器人内置电脑的 ip 地址。

# 二、电气接口

![](https://doc-cdn.unitree.com/static/2024/5/14/6f2e4b401d11425890bf2608fe624ad4_1579x374.png)





### 连接显示屏

![](https://doc-cdn.unitree.com/static/2023/12/4/a8815fef546b4d269d5e0d8f3c822ede_5329x2588.png)



## 三、关于建图扫描三维模型

SLAM 导航服务接口

SLAM 导航服务接口仅`支持带拓展坞和Unitree官方购入激光雷达（MID-360/XT16）版本`的EDU机器狗！！！

<img src="https://doc-cdn.unitree.com/static/2023/11/13/1c7dd63ff0a74c2c87dc295c704342af_2933x3088.png" style="zoom: 33%;" />



#### 介绍

SLAM与导航服务接口`使用DDS进行数据通信（兼容ROS2）`，使用前请确认通讯服务接口版本相匹配（拓展坞PC初始环境已配置完成），并确保处于`同一局域网`下。通过在局域网内发布或订阅不同的话题数据，即可实现SLAM与导航功能。SLAM与导航程序更新方法参考`应用开发->拓展坞配置->模块更新`，在`使用前请确认是否完成更新`，目前开放的服务接口如下表所示：

|      |      功能      |                 说明                  |
| :--: | :------------: | :-----------------------------------: |
|      |    开启建图    |  接收到相关指令后，自动打开建图节点   |
|      |    结束建图    | 自动保存 pcd 三维地图，并关闭建图节点 |
| SLAM |   开启重定位   | 接收到相关指令后，自动打开重定位节点  |
|      |  重定位初始化  |        接收给机器狗的初始位姿         |
|      | 实时重定位结果 |    在重定位过程发出机器狗实时位姿     |

|            |   功能    |             说明             |
| :--------: | :-------: | :--------------------------: |
|            | 增加点/边 | 增加本地的导航拓扑图点边信息 |
| 导航拓扑图 | 删除点/边 | 删除本地的导航拓扑图点边信息 |
|            | 查询点/边 | 查询本地的导航拓扑图点边信息 |

|      |         功能         |                   说明                   |
| :--: | :------------------: | :--------------------------------------: |
|      |       开启导航       |    接收到相关指令后，自动打开导航节点    |
|      |       单点导航       |       接收单个导航目标点，自动前往       |
|      | 多点循环导航（默认） |  接收到指令后，自动依次前往所有的拓扑点  |
| 导航 | 多点循环导航（设置） | 接收到指令后，自动依次前往接收到的拓扑点 |
|      |       暂停导航       |        暂停当前导航状态，停止不动        |
|      |       恢复导航       |             恢复当前导航状态             |
|      |       返回起点       |    返回起点位置（默认第一个点为起点）    |
|      |     关闭所有节点     |      接收到指令后，关闭所有功能节点      |



SLAM与导航服务接口`使用DDS进行数据通信（兼容ROS2）`，使用前请确认通讯服务接口版本相匹配（拓展坞PC初始环境已配置完成），并确保处于`同一局域网`下。通过在局域网内发布或订阅不同的话题数据，即可实现SLAM与导航功能。SLAM与导航程序更新方法参考`应用开发->拓展坞配置->模块更新`，在`使用前请确认是否完成更新`，目前开放的服务接口如下表所示：

#### 通信话题说明

**1.**`“rt/qt_command” 类型：QtCommand`

SLAM与导航功能接收指令的话题，通过发布该话题对应消息，可以进行对应功能操作。除增加拓扑点边信息外，其余功能操作均可通过该话题实现。

| command值 |        功能        |
| :-------: | :----------------: |
|     1     |   删除点/边信息    |
|     2     |   查询点/边信息    |
|     3     |      开启建图      |
|     4     |      结束建图      |
|     6     |     开启重定位     |
|     7     |    重定位初始化    |
|     8     |      开启导航      |
|     9     |      单点导航      |
|    10     | 多点循环导航(默认) |
|    11     | 多点循环导航(设置) |
|    13     |      暂停导航      |
|    14     |      恢复导航      |
|    15     |      返回起点      |
|    99     |    关闭所有节点    |

##### 建图过程注意事项

![img](https://doc-cdn.unitree.com/static/2024/9/20/23201f8365704009b1196f32c90d4bb0_680x333.png)



5.按下‘w’键，程序开启建图，在建图开始前需大致**记下建图起始位置和机器狗的朝向**；
6.遥控机器狗走到需要建图的区域，遥控时请控制**机器狗行走速度和转弯速度不要太快**，最后**返回起点位置**；
7.按下‘e’键，结束建图，三维PCD图保存在/unitree/module/graph_pid_ws/config_files/lio_sam_config/maps/pcd/default/GlobalMap.pcd中；
8.遥控机器狗至`建图起始位置`，按下‘z’按键，打开定位节点并进行定位初始化；
9.按下‘x’键将起始点作为第一个导航拓扑点，第一个拓扑点尽量打在`环境比较空旷且周围没有障碍物`的地方。然后遥控机器狗至其他导航点的位置，达到后按下'x'键，依次采集所有的导航拓扑点/边信息，采集完成后`按下‘c'保存点边信息`,然后按下‘q'键关闭节点，第一个拓扑点1.5m范围内请勿采集其他拓扑点；
10.遥控机器狗至`建图起始位置`，按下‘a’键开启自动循环导航。在机器狗行走过程中，可通过按键‘s’和‘d’进行暂停和恢复。若后续无需更改导航地图信息，则可以直接跳过步骤5～步骤9，实现自动循环导航。

`demo使用注意：`
1.所有的测试程序都依赖`123网段`的网卡进行通讯，请确认程序中网卡配置是否正确，在使用SLAM与导航功能时请关闭避障功能；
2.demo程序中按照采集的先后顺序连接拓扑点，`未进行闭环连接`，即最后一个拓扑点未连接第一个拓扑点，用户可修改4中边文件手动进行闭环连接。demo中导航过程按照拓扑图的路线进行逐点导航，即导航顺序为1->2->3->1->2->3->1->~~~~~，以此类推；
3.在/unitree/lib/unitree_slam/rviz2目录下存放有rviz2配置文件build_map.rviz和costmap.rviz,可通过rviz2界面中File->Open Config选择对应的配置文件，查看建图和导航过程；
4.拓展坞PC计算资源有限，建议在使用该接口时`关闭其他占用计算资源的程序，如rviz2`等；
5.由于雷达安装角度原因，其对`低于机器狗身体高度的障碍物`识别避障效果相对较差;
6.点/边文件信息可在拓展坞PC中进行手动修改，文件目录为/unitree/module/graph_pid_ws/src/QT_Server/graph_map/Make_Graph/Floor_0/pcd_0，文件名为Make_Graph_node_0_0_0.txt和Make_Graph_edge_0_0_0.txt，其格式如下图所示，`手动修改后需重新启动导航接口服务的脚本文件`，使其信息加载进程序中。

```
建图注意事项：
```

1. 时间选择：尽量在待扫区域人流较少的时间点进行扫图，以减少干扰。
2. 物体清除：清除待扫区域中经常移动的物体，如经常活动的人群、移动的家具等，以确保建图过程中的环境稳定性。
3. 处理特殊物体：对于具有反光、透光或吸光特性的物体（如镜子、玻璃等），在不影响雷达扫描的前提下，可以使用其他材料覆盖，以确保雷达能够正常扫描并获取准确的环境信息。
4. 建议建图范围：推荐将待扫区域控制在30米×30米的范围内，以保证建图的效果和精度。
5. 选择特征明显的场景：在建图过程中，选择具有明显特征的场景进行扫图，避免退化环境（如长直走廊）对建图质量的影响。
6. 运动轨迹控制：在建图过程中，保持机器人的运动速度稳定。让机器人围绕场景走一个回环，并在转角区域进行原地旋转360度。
7. 避免重复行走：如果地图已经建好，尽量避免在已建好的地图区域内反复来回行走，以防止重复扫描和数据混淆。建议尽快保存已完成的地图。

这些准备工作和注意事项将有助于提高建图的质量和准确性，并确保在建图过程中获得可靠的环境信息。

note

不同版本 SLAM 接口可能有差异，建议您将拓展坞更新到最新的 SLAM 版本，更新方式详见 [拓展坞拓展](https://support.unitree.com/home/zh/developer/module_update)

![](.\img\1.png)

